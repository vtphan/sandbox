{% extends "layout.html" %}
{% block content %}

<strong>{{board_name}}'s whiteboard</strong>

<!-- CODE and OUTPUT -->
<div class="row-fluid">
  <div class="span6" style="height:400px !important; overflow:scroll;">
  {% if show_editor: %}
    <div id="codearea"><textarea id="code" name="code" class="span12" rows="35"></textarea></div>
  {% else: %}
    <pre id="pre-code"></pre>
  {% endif %}
  </div>
  <div class="span6" style="height:400px !important; overflow:scroll;">
    <pre id="result"></pre>
  </div>
</div>

<!-- CHAT -->
<div class="row">
  <div class="span12">
    <input id="chat-input" class="span12 input-small" type="text" placeholder="feedbacks..." style="width:100%;"/>
  </div>
  <div class="span11" style="height:200px !important; overflow:scroll;">
    <div type="text" id="chat-output"></div>
  </div>
</div>

<script type="text/javascript">
  $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
  $('#chat-input').keyup(function(e){
      if (e.keyCode == 13) {
          $.post($SCRIPT_ROOT + '/send_message/{{channel}}', {'message': $(this).val(), 'type':'chat'});
          $(this).val('');
      }
  });

  $(function() {
    var result = new EventSource('/stream/{{channel}}');
    result.onmessage = function(e) {
      if (e.data == ''){ return; }
      var data = $.parseJSON(e.data);

      {% if not show_editor: %}
        if (data['code']) { $('#pre-code').html(data.code); }
      {% endif %}

      if (data.output) { $('#result').html(data.output); }
      if (data.chat) { $('#chat-output').html( data.chat + $('#chat-output').html() ); }
    };
  });
</script>

{% if show_editor: %}
  <script src="{{ url_for('static', filename='codemirror/codemirror.js') }}"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='codemirror/codemirror.css') }}">
  <script src="{{ url_for('static', filename='codemirror/python.js') }}"></script>

  <script type="text/javascript">
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
      mode: {name: "python", version: 2, singleLineStringErrors: false},
      lineNumbers: true,
      indentUnit: 3,
      tabMode: "shift",
      // matchBrackets: true,
      onKeyEvent : function( ed, ev ) {
        if (ev.keyCode == 13){
          if ( ev.shiftKey && ev.type == 'keyup' ) {
            $.post($SCRIPT_ROOT + '/send_message/{{channel}}', {'message': editor.getValue(), 'type':'code'});
          }
          else {
            $.post($SCRIPT_ROOT + '/send_message/{{channel}}', {'message': editor.getValue(), 'type':'code_noexec'});
          }
          ev.preventDefault();
        }
      }
    });
    $(function() {
      editor.focus();
      return false;
    });
  </script>
{% endif %}

{% endblock %}