{% extends "layout.html" %}
{% block content %}

<div id="channel-name">{{channel_name}}'s whiteboard</div>
<input type="hidden" value="{{channel}}" id="channel" />

<!-- CODE and OUTPUT -->
<div class="row-fluid">
  <div class="span6" style="height:400px !important; overflow:scroll;">
  {% if show_editor: %}
    <div id="codearea"><textarea id="code" name="code" class="span12" rows="35"></textarea></div>
  {% else: %}
    <pre id="pre-code"></pre>
  {% endif %}
  </div>
  <div class="span6" style="height:400px !important; overflow:scroll;">
    <pre id="result"></pre>
  </div>
</div>

<!-- CHAT -->
<div class="row">
  <div class="span6">
    <input id="chat-input" class="input-small" type="text" placeholder="feedbacks..." style="width:100%;"/>
    <div style="height:200px !important; overflow:scroll;">
      <div type="text" id="chat-output"></div>
    </div>
  </div>
  <div class="span6">
    {% for s in students: %}
    <div><a href="{{s.id}}" class="channel">{{ s.username }}</a></div>
    {% endfor %}
  </div>
</div>

<script type="text/javascript">
  $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

  function parse_streaming_message(c){
   function f(e) {
      var channel_data = $.parseJSON(e.data);
      if (channel_data['channel-' + c]) {
        var data = channel_data['channel-' + c];

        {% if not show_editor: %}
          if (data['code']) { $('#pre-code').html(data.code); }
        {% endif %}

        if (data.output) { $('#result').html(data.output); }
        if (data.chat) { $('#chat-output').html( data.chat + $('#chat-output').html() ); }
      }
    }

    return f;
  }

  $(document).ready(function(){
    $('#chat-input').keyup(function(e){
      if (e.keyCode == 13) {
        $.post($SCRIPT_ROOT+'/send_message',{'message': $(this).val(),'type':'chat','channel':$('#channel').val()});
        $(this).val('');
      }
    });

    /* this does not allow efficient channel switching */
    var result = new EventSource('/stream/{{channel}}');
    result.onmessage = parse_streaming_message( $('#channel').val() );
    $('.channel').click(function(e){
      var cid = $(this).attr('href');
      $('#channel-name').html(cid + "'s whiteboard");
      $('#channel').val(cid);
      result.onmessage = parse_streaming_message( $('#channel').val() );
      e.preventDefault();
    });
  });
</script>

{% if show_editor: %}
  <script src="{{ url_for('static', filename='codemirror/codemirror.js') }}"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='codemirror/codemirror.css') }}">
  <script src="{{ url_for('static', filename='codemirror/python.js') }}"></script>

  <script type="text/javascript">
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
      mode: {name: "python", version: 2, singleLineStringErrors: false},
      lineNumbers: true,
      indentUnit: 3,
      tabMode: "shift",
      // matchBrackets: true,
      onKeyEvent : function( ed, ev ) {
        if (ev.keyCode == 13){
          if ( ev.shiftKey && ev.type == 'keyup' ) {
            $.post($SCRIPT_ROOT + '/send_message', {'message': editor.getValue(), 'type':'code', 'channel':$('#channel').val()});
            $('#result').html('running...');
          }
          else {
            $.post($SCRIPT_ROOT + '/send_message', {'message': editor.getValue(), 'type':'code_noexec', 'channel':$('#channel').val()});
          }
          ev.preventDefault();
        }
      }
    });
    $(function() {
      editor.focus();
      return false;
    });
  </script>
{% endif %}

{% endblock %}