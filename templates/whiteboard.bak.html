{% extends "layout.html" %}
{% block content %}
<script src="{{ url_for('static', filename='codemirror/codemirror.js') }}"></script>
<script src="{{ url_for('static', filename='codemirror/matchbrackets.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='codemirror/codemirror.css') }}">
<script src="{{ url_for('static', filename='codemirror/python.js') }}"></script>

<h1>Whiteboard for user {{user.username}}</h1>
<div id="codearea">
  <textarea id="code" name="code"></textarea>
  <h5>press Shift+Enter to execute your code.</h5>
</div>

<div id="resultarea">
  <h2>Output</h2>
  <div id="result">?</div>
</div>

<script type="text/javascript">
  var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
    mode: {name: "python", version: 2, singleLineStringErrors: false},
    lineNumbers: true,
    indentUnit: 3,
    tabMode: "shift",
    matchBrackets: true,
    onKeyEvent : function( ed, ev ) {
      if (ev.keyCode == 13 && ev.shiftKey){
        if ( ev.type == 'keyup' ) {
          $.post('/run_code/{{user.id}}', {'code': editor.getValue()});
          $(this).val('');
          // run_code();
        }
        ev.preventDefault();
      }
    }
  });
  // var run_code = function () {
  //   $('#result').html('running...');
  //   $.getJSON($SCRIPT_ROOT+'/run_code', { code: editor.getValue() },
  //     function(data){ $('#result').html(data.result);
  //   });
  // }
  $(function() {
    editor.focus();
    // $('#run').bind('click', run_code);
    var source = new EventSource('/stream/out/{{user.id}}');
    source.onmessage = function(e) { $('#result').html(e.data); };
    return false;
  });


</script>
{% endblock %}